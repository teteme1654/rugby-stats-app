<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rugby Stats - 表示画面</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial Black', 'Arial', sans-serif;
      background: #434752;
      color: white;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    .background-logo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.2;
      z-index: 0;
      pointer-events: none;
    }

    .main-container {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 40px 60px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .team-header {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      padding: 15px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
    }

    .team-header.away {
      justify-content: flex-end;
    }

    .team-logo {
      width: 120px;
      height: 120px;
      object-fit: contain;
      padding: 10px;
      background: rgba(255, 255, 255, 0.0);
      border-radius: 8px;
    }

    .team-name {
      font-size: var(--team-name-size, 2em);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: white;
    }

    .score-section {
      display: flex;
      align-items: center;
      gap: 40px;
      padding: 0 40px;
    }

    .score-column {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .score-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 2.2em;
      font-weight: 700;
    }

    .score-label {
      font-size: 1em;
      color: rgb(255, 255, 255);
      min-width: 60px;
    }

    .score-column.away .score-label {
      text-align: left;
    }

    .score-value {
      font-size: 1.3em;
      color: white;
      font-weight: 900;
      min-width: 70px;
      text-align: right;
    }

    .score-column.away .score-value {
      text-align: left;
    }

    .main-score {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .score {
      font-size: 7em;
      font-weight: 900;
      color: white;
    }

    .score-separator {
      font-size: 7em;
      color: #666;
      font-weight: 900;
    }

    .body-container {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 40px;
      flex: 1;
      overflow: hidden;
    }

    .players-column {
      display: flex;
      flex-direction: column;
    }

    .players-column.host {
      border-left: 5px solid var(--host-color, #ff6b35);
      padding-left: 20px;
    }

    .players-column.away {
      border-right: 5px solid var(--away-color, #4a90e2);
      padding-right: 20px;
      align-items: flex-start;
    }

    .player-item {
      font-size: 2em;
      padding: 0px 0;
      margin: -2px 0;
      font-weight: 700;
      display: grid;
      grid-template-columns: 50px 120px 1fr;
      gap: 10px;
      align-items: center;
    }

    .player-number {
      font-size: 1.1em;
      min-width: 35px;
      text-align: center;
    }

    .players-column.host .player-number {
      color: #ffffff;
    }

    .players-column.away .player-number {
      color: #ffffff;
    }

    .player-name {
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .player-position {
      color: #ffffff;
      font-size: 1em;
      text-align: center;
    }

    .stats-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
      min-width: 400px;
    }

    .stats-header {
      display: grid;
      grid-template-columns: 120px 100px 120px;
      gap: 20px;
      align-items: center;
      margin-bottom: 10px;
    }

    .stats-col {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }

    .stats-col.host-stats {
      justify-content: flex-end;
    }

    .stats-col.away-stats {
      justify-content: flex-start;
    }

    .stats-col.stat-names {
      justify-content: center;
    }

    .half-label {
      font-size: 2em;
      color: rgba(255,255,255,0.9);
      font-weight: 700;
      min-width: 50px;
      text-align: center;
    }

    .stat-row {
      display: grid;
      grid-template-columns: 120px 100px 120px;
      gap: 20px;
      align-items: center;
      font-size: 3em;
      font-weight: 900;
    }

    .stat-value {
      color: white;
      min-width: 45px;
      text-align: center;
    }

    .stat-label {
      color: white;
      text-align: center;
      font-size: 1em;
      letter-spacing: 2px;
      font-weight: 900;
      transform: scaleX(0.5);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .player-item {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="background-logo" id="backgroundLogo"></div>
  
  <div class="main-container">
    <div class="header">
      <div class="team-header host">
        <img src="" alt="" class="team-logo" id="hostLogo" onerror="this.style.display='none'">
        <div class="team-name" id="hostName">PHOENIX WARRIORS</div>
      </div>

      <div class="score-section">
        <!-- ホーム側スコア -->
        <div class="score-column host">
          <div class="score-row">
            <span class="score-label">前半</span>
            <span class="score-value" id="hostFirstHalfScore">12</span>
          </div>
          <div class="score-row">
            <span class="score-label">後半</span>
            <span class="score-value" id="hostSecondHalfScore">12</span>
          </div>
        </div>

        <!-- 中央メインスコア -->
        <div class="main-score">
          <div class="score" id="hostScore">24</div>
          <div class="score-separator">-</div>
          <div class="score" id="awayScore">17</div>
        </div>

        <!-- アウェイ側スコア -->
        <div class="score-column away">
          <div class="score-row">
            <span class="score-value" id="awayFirstHalfScore">10</span>
            <span class="score-label">前半</span>
          </div>
          <div class="score-row">
            <span class="score-value" id="awaySecondHalfScore">7</span>
            <span class="score-label">後半</span>
          </div>
        </div>
      </div>

      <div class="team-header away">
        <div class="team-name" id="awayName">THUNDER KNIGHTS</div>
        <img src="" alt="" class="team-logo" id="awayLogo" onerror="this.style.display='none'">
      </div>
    </div>

    <div class="body-container">
      <div class="players-column host" id="hostPlayersList"></div>

      <div class="stats-panel">
        <!-- ヘッダー行 -->
        <div class="stats-header">
          <div class="stats-col host-stats">
            <span class="half-label">後</span>
            <span class="half-label">前</span>
          </div>
          <div class="stats-col stat-names"></div>
          <div class="stats-col away-stats">
            <span class="half-label">前</span>
            <span class="half-label">後</span>
          </div>
        </div>

        <!-- TRY -->
        <div class="stat-row">
          <div class="stats-col host-stats">
            <span class="stat-value" id="hostTriesFirst">2</span>
            <span class="stat-value" id="hostTriesSecond">1</span>
          </div>
          <div class="stats-col stat-names">
            <span class="stat-label">TRY</span>
          </div>
          <div class="stats-col away-stats">
            <span class="stat-value" id="awayTriesFirst">1</span>
            <span class="stat-value" id="awayTriesSecond">1</span>
          </div>
        </div>

        <!-- CG -->
        <div class="stat-row">
          <div class="stats-col host-stats">
            <span class="stat-value" id="hostConversionsFirst">2</span>
            <span class="stat-value" id="hostConversionsSecond">1</span>
          </div>
          <div class="stats-col stat-names">
            <span class="stat-label">CG</span>
          </div>
          <div class="stats-col away-stats">
            <span class="stat-value" id="awayConversionsFirst">1</span>
            <span class="stat-value" id="awayConversionsSecond">1</span>
          </div>
        </div>

        <!-- PG -->
        <div class="stat-row">
          <div class="stats-col host-stats">
            <span class="stat-value" id="hostPGFirst">1</span>
            <span class="stat-value" id="hostPGSecond">0</span>
          </div>
          <div class="stats-col stat-names">
            <span class="stat-label">PG</span>
          </div>
          <div class="stats-col away-stats">
            <span class="stat-value" id="awayPGFirst">1</span>
            <span class="stat-value" id="awayPGSecond">0</span>
          </div>
        </div>

        <!-- DG -->
        <div class="stat-row">
          <div class="stats-col host-stats">
            <span class="stat-value" id="hostDGFirst">0</span>
            <span class="stat-value" id="hostDGSecond">0</span>
          </div>
          <div class="stats-col stat-names">
            <span class="stat-label">DG</span>
          </div>
          <div class="stats-col away-stats">
            <span class="stat-value" id="awayDGFirst">0</span>
            <span class="stat-value" id="awayDGSecond">0</span>
          </div>
        </div>

        <!-- PT -->
        <div class="stat-row">
          <div class="stats-col host-stats">
            <span class="stat-value" id="hostPTFirst">0</span>
            <span class="stat-value" id="hostPTSecond">0</span>
          </div>
          <div class="stats-col stat-names">
            <span class="stat-label">PT</span>
          </div>
          <div class="stats-col away-stats">
            <span class="stat-value" id="awayPTFirst">0</span>
            <span class="stat-value" id="awayPTSecond">0</span>
          </div>
        </div>
      </div>

      <div class="players-column away" id="awayPlayersList"></div>
    </div>
  </div>

  <script>
    let currentData = null;

    // 全角カナを半角カナに変換する関数
    function toHalfWidthKana(str) {
      return str
        .replace(/[\u3041-\u3096]/g, (match) => {
          return String.fromCharCode(match.charCodeAt(0) + 0x60);
        })
        .replace(/[\u30a1-\u30f6]/g, (match) => {
          const kanaMap = {
            'ァ':'ｧ','ア':'ｱ','ィ':'ｨ','イ':'ｲ','ゥ':'ｩ','ウ':'ｳ','ェ':'ｪ','エ':'ｴ','ォ':'ｫ','オ':'ｵ',
            'カ':'ｶ','ガ':'ｶﾞ','キ':'ｷ','ギ':'ｷﾞ','ク':'ｸ','グ':'ｸﾞ','ケ':'ｹ','ゲ':'ｹﾞ','コ':'ｺ','ゴ':'ｺﾞ',
            'サ':'ｻ','ザ':'ｻﾞ','シ':'ｼ','ジ':'ｼﾞ','ス':'ｽ','ズ':'ｽﾞ','セ':'ｾ','ゼ':'ｾﾞ','ソ':'ｿ','ゾ':'ｿﾞ',
            'タ':'ﾀ','ダ':'ﾀﾞ','チ':'ﾁ','ヂ':'ﾁﾞ','ッ':'ｯ','ツ':'ﾂ','ヅ':'ﾂﾞ','テ':'ﾃ','デ':'ﾃﾞ','ト':'ﾄ','ド':'ﾄﾞ',
            'ナ':'ﾅ','ニ':'ﾆ','ヌ':'ﾇ','ネ':'ﾈ','ノ':'ﾉ',
            'ハ':'ﾊ','バ':'ﾊﾞ','パ':'ﾊﾟ','ヒ':'ﾋ','ビ':'ﾋﾞ','ピ':'ﾋﾟ','フ':'ﾌ','ブ':'ﾌﾞ','プ':'ﾌﾟ','ヘ':'ﾍ','ベ':'ﾍﾞ','ペ':'ﾍﾟ','ホ':'ﾎ','ボ':'ﾎﾞ','ポ':'ﾎﾟ',
            'マ':'ﾏ','ミ':'ﾐ','ム':'ﾑ','メ':'ﾒ','モ':'ﾓ',
            'ャ':'ｬ','ヤ':'ﾔ','ュ':'ｭ','ユ':'ﾕ','ョ':'ｮ','ヨ':'ﾖ',
            'ラ':'ﾗ','リ':'ﾘ','ル':'ﾙ','レ':'ﾚ','ロ':'ﾛ',
            'ヮ':'ﾜ','ワ':'ﾜ','ヰ':'ｲ','ヱ':'ｴ','ヲ':'ｦ','ン':'ﾝ',
            'ヴ':'ｳﾞ','ー':'ｰ','・':'･','「':'｢','」':'｣','。':'｡','、':'､'
          };
          return kanaMap[match] || match;
        });
    }

    async function loadData() {
      try {
        currentData = await window.electronAPI.getMatchData();
        updateDisplay(currentData);
      } catch (error) {
        console.error('データ読み込みエラー:', error);
      }
    }

    window.electronAPI.onUpdateData((data) => {
      currentData = data;
      updateDisplay(data);
    });
    
    // チーム名サイズ更新リスナー
    window.electronAPI.onUpdateTeamNameSize((size) => {
      document.documentElement.style.setProperty('--team-name-size', `${size}em`);
    });

    function updateDisplay(data) {
      if (!data) return;

      console.log('=== updateDisplay 呼び出し ===');
      console.log('全データ:', data);
      console.log('ホームチーム:', data.hostTeam);
      console.log('ホームチームロゴ:', data.hostTeam.logo);

      // CSS変数でチームカラーを設定
      document.documentElement.style.setProperty('--host-color', data.hostTeam.color || '#ff6b35');
      document.documentElement.style.setProperty('--away-color', data.awayTeam.color || '#4a90e2');

      // 背景ロゴを設定（クリティカル修正）
      const bgLogo = document.getElementById('backgroundLogo');
      console.log('backgroundLogo要素:', bgLogo);
      
      if (bgLogo) {
        if (data.hostTeam.logo) {
          bgLogo.style.backgroundImage = `url("${data.hostTeam.logo}")`;
          bgLogo.style.display = 'block';
          console.log('✅ 背景ロゴ設定成功:', data.hostTeam.logo);
          console.log('backgroundImage:', bgLogo.style.backgroundImage);
          console.log('display:', bgLogo.style.display);
        } else {
          bgLogo.style.backgroundImage = 'none';
          bgLogo.style.display = 'none';
          console.log('❌ 背景ロゴ未設定（ロゴURLが空です）');
        }
      } else {
        console.error('❌ backgroundLogo要素が見つかりません');
      }

      // ホームチームヘッダーにカラーを適用
      const hostHeader = document.querySelector('.team-header.host');
      hostHeader.style.background = `linear-gradient(90deg, ${data.hostTeam.color}70, transparent)`;
      hostHeader.style.borderLeft = `4px solid ${data.hostTeam.color}`;

      document.getElementById('hostName').textContent = data.hostTeam.name.toUpperCase();
      document.getElementById('hostScore').textContent = data.score.host;
      
      // 前半/後半スコア
      document.getElementById('hostFirstHalfScore').textContent = data.halfScores.first.host;
      document.getElementById('hostSecondHalfScore').textContent = data.halfScores.second.host;
      
      // 前半/後半統計
      document.getElementById('hostTriesFirst').textContent = data.stats.host.first.tries;
      document.getElementById('hostTriesSecond').textContent = data.stats.host.second.tries;
      document.getElementById('hostConversionsFirst').textContent = data.stats.host.first.conversions;
      document.getElementById('hostConversionsSecond').textContent = data.stats.host.second.conversions;
      document.getElementById('hostPGFirst').textContent = data.stats.host.first.penaltyGoals;
      document.getElementById('hostPGSecond').textContent = data.stats.host.second.penaltyGoals;
      document.getElementById('hostDGFirst').textContent = data.stats.host.first.dropGoals || 0;
      document.getElementById('hostDGSecond').textContent = data.stats.host.second.dropGoals || 0;
      document.getElementById('hostPTFirst').textContent = data.stats.host.first.penaltyTries || 0;
      document.getElementById('hostPTSecond').textContent = data.stats.host.second.penaltyTries || 0;
      
      const hostLogo = document.getElementById('hostLogo');
      if (data.hostTeam.logo) {
        hostLogo.src = data.hostTeam.logo;
        hostLogo.style.display = 'block';
      }

      // アウェイチームヘッダーにカラーを適用
      const awayHeader = document.querySelector('.team-header.away');
      awayHeader.style.background = `linear-gradient(270deg, ${data.awayTeam.color}70, transparent)`;
      awayHeader.style.borderRight = `4px solid ${data.awayTeam.color}`;

      document.getElementById('awayName').textContent = data.awayTeam.name.toUpperCase();
      document.getElementById('awayScore').textContent = data.score.away;
      
      // 前半/後半スコア
      document.getElementById('awayFirstHalfScore').textContent = data.halfScores.first.away;
      document.getElementById('awaySecondHalfScore').textContent = data.halfScores.second.away;
      
      // 前半/後半統計
      document.getElementById('awayTriesFirst').textContent = data.stats.away.first.tries;
      document.getElementById('awayTriesSecond').textContent = data.stats.away.second.tries;
      document.getElementById('awayConversionsFirst').textContent = data.stats.away.first.conversions;
      document.getElementById('awayConversionsSecond').textContent = data.stats.away.second.conversions;
      document.getElementById('awayPGFirst').textContent = data.stats.away.first.penaltyGoals;
      document.getElementById('awayPGSecond').textContent = data.stats.away.second.penaltyGoals;
      document.getElementById('awayDGFirst').textContent = data.stats.away.first.dropGoals || 0;
      document.getElementById('awayDGSecond').textContent = data.stats.away.second.dropGoals || 0;
      document.getElementById('awayPTFirst').textContent = data.stats.away.first.penaltyTries || 0;
      document.getElementById('awayPTSecond').textContent = data.stats.away.second.penaltyTries || 0;

      
      const awayLogo = document.getElementById('awayLogo');
      if (data.awayTeam.logo) {
        awayLogo.src = data.awayTeam.logo;
        awayLogo.style.display = 'block';
      }

      updatePlayersList('host', data.players.host);
      updatePlayersList('away', data.players.away);
    }

    function updatePlayersList(team, players) {
      const container = document.getElementById(`${team}PlayersList`);

      if (!players || players.length === 0) {
        return;
      }

      // 配列の最初の15人を表示
      const onFieldPlayers = players.slice(0, 15);

      container.innerHTML = onFieldPlayers.map(p => {
        // 名前が16文字以上の場合は半角カナに変換
        const displayName = p.name.length > 16 ? toHalfWidthKana(p.name) : p.name;
        
        return `
          <div class="player-item">
            <span class="player-number">${p.number}</span>
            <span class="player-position">${p.position || ''}</span>
            <span class="player-name">${displayName.toUpperCase()}</span>
          </div>
        `;
      }).join('');
    }

    window.addEventListener('DOMContentLoaded', () => {
      console.log('=== DOMContentLoaded ===');
      const bgLogo = document.getElementById('backgroundLogo');
      console.log('backgroundLogo要素の存在確認:', bgLogo);
      if (bgLogo) {
        console.log('初期backgroundImage:', bgLogo.style.backgroundImage);
        console.log('初期display:', bgLogo.style.display);
      }
      loadData();
    });
  </script>
</body>
</html>
